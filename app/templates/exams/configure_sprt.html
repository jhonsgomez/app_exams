{% extends 'base.html' %}

{% block title %}
  Configurar SPRT - {{ exam.title }}
{% endblock %}

{% block content %}
  <div class="min-h-screen bg-gray-100 py-6">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="mb-6">
        <a href="{% url 'exams_table' %}" class="inline-flex items-center text-indigo-600 hover:text-indigo-800"><i class="fas fa-arrow-left mr-2"></i> Volver</a>
      </div>

      <div class="bg-white shadow rounded-lg p-8">
        <div class="mb-6">
          <h1 class="text-2xl font-bold text-gray-900">Configuración SPRT</h1>
          <p class="text-gray-600 mt-1">{{ exam.title }}</p>
        </div>

        <!-- Información sobre SPRT -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="fas fa-info-circle text-blue-500 text-xl"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-blue-800">Sobre el Test Secuencial de Razón de Probabilidad (SPRT)</h3>
              <div class="mt-2 text-sm text-blue-700">
                <p>El SPRT permite evaluar la competencia del estudiante con el mínimo número de preguntas necesarias. Los parámetros determinan:</p>
                <ul class="list-disc ml-5 mt-2">
                  <li>
                    <strong>P0:</strong> Probabilidad mínima aceptable para considerar competente al estudiante
                  </li>
                  <li>
                    <strong>P1:</strong> Probabilidad que indica incompetencia
                  </li>
                  <li>
                    <strong>Alpha (α):</strong> Probabilidad de rechazar incorrectamente a un estudiante competente
                  </li>
                  <li>
                    <strong>Beta (β):</strong> Probabilidad de aprobar incorrectamente a un estudiante incompetente
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <form method="post" action="{% url 'exams_configure_sprt' exam.id %}">
          {% csrf_token %}

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Parámetros de probabilidad -->
            <div class="space-y-4">
              <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">
                <i class="fas fa-percentage text-indigo-600 mr-2"></i>
                Parámetros de Probabilidad
              </h3>

              <div>
                <label for="p0" class="block text-sm font-medium text-gray-700">P0 - Probabilidad de Competencia (%)</label>
                <input type="number" name="p0" id="p0" value="{{ sprt_config.p0 }}" step="0.1" min="50" max="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required />
                <p class="mt-1 text-xs text-gray-500">Probabilidad mínima para considerar competente (recomendado: 60%)</p>
              </div>

              <div>
                <label for="p1" class="block text-sm font-medium text-gray-700">P1 - Probabilidad de Incompetencia (%)</label>
                <input type="number" name="p1" id="p1" value="{{ sprt_config.p1 }}" step="0.1" min="0" max="50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required />
                <p class="mt-1 text-xs text-gray-500">Probabilidad que indica incompetencia (recomendado: 40%)</p>
              </div>
            </div>

            <!-- Parámetros de error -->
            <div class="space-y-4">
              <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">
                <i class="fas fa-exclamation-triangle text-indigo-600 mr-2"></i>
                Parámetros de Error
              </h3>

              <div>
                <label for="alpha" class="block text-sm font-medium text-gray-700">Alpha (α) - Error Tipo I</label>
                <input type="number" name="alpha" id="alpha" value="{{ sprt_config.alpha }}" step="0.01" min="0.01" max="0.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required />
                <p class="mt-1 text-xs text-gray-500">Riesgo de reprobar a alguien competente (recomendado: 0.10)</p>
              </div>

              <div>
                <label for="beta" class="block text-sm font-medium text-gray-700">Beta (β) - Error Tipo II</label>
                <input type="number" name="beta" id="beta" value="{{ sprt_config.beta }}" step="0.01" min="0.01" max="0.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required />
                <p class="mt-1 text-xs text-gray-500">Riesgo de aprobar a alguien incompetente (recomendado: 0.10)</p>
              </div>
            </div>
          </div>

          <!-- Parámetros de progresión por niveles -->
          <div class="mt-8 space-y-4">
            <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">
              <i class="fas fa-layer-group text-indigo-600 mr-2"></i>
              Progresión por Niveles de Dificultad
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="min_questions_per_level" class="block text-sm font-medium text-gray-700">Mínimo de preguntas por nivel</label>
                <input type="number" name="min_questions_per_level" id="min_questions_per_level" value="{{ sprt_config.min_questions_per_level }}" min="1" max="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required />
                <p class="mt-1 text-xs text-gray-500">Cantidad mínima de preguntas antes de evaluar avance</p>
              </div>

              <div>
                <label for="success_threshold_to_advance" class="block text-sm font-medium text-gray-700">Umbral de éxito para avanzar (0-1)</label>
                <input type="number" name="success_threshold_to_advance" id="success_threshold_to_advance" value="{{ sprt_config.success_threshold_to_advance }}" step="0.05" min="0.5" max="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required />
                <p class="mt-1 text-xs text-gray-500">Porcentaje de aciertos necesario para avanzar al siguiente nivel (ej: 0.70 = 70%)</p>
              </div>
            </div>
          </div>

          <!-- Calculadora de límites -->
          <div class="mt-8 p-4 bg-gray-50 rounded-lg">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
              <i class="fas fa-calculator text-indigo-600 mr-2"></i>
              Vista Previa de Límites Calculados
            </h3>

            <div class="grid grid-cols-2 gap-4">
              <div class="text-center p-4 bg-green-100 rounded-lg">
                <p class="text-sm text-green-800">Límite Inferior (Aprobación)</p>
                <p class="text-2xl font-bold text-green-700" id="lower-limit-preview">-</p>
                <p class="text-xs text-green-600 mt-1">Si S ≤ este valor → APROBADO</p>
              </div>
              <div class="text-center p-4 bg-red-100 rounded-lg">
                <p class="text-sm text-red-800">Límite Superior (Reprobación)</p>
                <p class="text-2xl font-bold text-red-700" id="upper-limit-preview">-</p>
                <p class="text-xs text-red-600 mt-1">Si S ≥ este valor → REPROBADO</p>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div class="mt-8 flex justify-end space-x-4">
            <a href="{% url 'exams_table' %}" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 cursor-pointer">Cancelar</a>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 cursor-pointer save-btn"><i class="fas fa-save mr-2"></i> Guardar Configuración</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const alphaInput = document.getElementById('alpha')
      const betaInput = document.getElementById('beta')
      const lowerLimitPreview = document.getElementById('lower-limit-preview')
      const upperLimitPreview = document.getElementById('upper-limit-preview')
    
      function updateLimitsPreview() {
        const alpha = parseFloat(alphaInput.value) || 0.1
        const beta = parseFloat(betaInput.value) || 0.1
    
        const lowerLimit = Math.log(beta / (1 - alpha))
        const upperLimit = Math.log((1 - beta) / alpha)
    
        lowerLimitPreview.textContent = lowerLimit.toFixed(4)
        upperLimitPreview.textContent = upperLimit.toFixed(4)
      }
    
      alphaInput.addEventListener('input', updateLimitsPreview)
      betaInput.addEventListener('input', updateLimitsPreview)
    
      // Calcular al cargar la página
      updateLimitsPreview()
    })
  </script>
{% endblock %}

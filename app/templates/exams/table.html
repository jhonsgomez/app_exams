{% extends 'base_table.html' %}
{% load tz %}

{% block page_title %}
  Gestión | Exámenes
{% endblock %}

{% block back_button %}
  <a href="{% url 'dashboard' %}" class="inline-flex items-center text-indigo-600"><i class="fas fa-arrow-left mr-2"></i><span class="hover:underline">Regresar</span></a>
{% endblock %}

{% block crud_title %}
  Listado de
{% endblock %} {% block crud_badge %}
  Exámenes
{% endblock %}

{% block create_button %}
  {% if request.user.role.name == 'super_admin' or request.user.role.name == 'admin' %}
    <a href="{% url 'exams_create' %}" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 mr-2"><i class="fas fa-plus py-1"></i></a>
  {% endif %}
{% endblock %}

{% block table_header %}
  <tr class="text-gray-800 text-sm">
    <th class="px-4 py-2">#</th>
    <th class="px-4 py-2">Título</th>
    <th class="px-4 py-2">Inicio - Fin</th>
    <th class="px-4 py-2">Acciones</th>
  </tr>
{% endblock %}

{% block table_body %}
  {% for exam in page_obj %}
    <tr class="text-center">
      <td class="px-4 py-2">{{ forloop.counter }}</td>
      <td class="px-4 py-2 text-left">
        <div class="font-semibold">{{ exam.title }}</div>
        <div class="text-sm text-gray-600">{{ exam.description|truncatewords:10 }}</div>
        <div class="text-sm text-gray-600 mt-1"><span class="font-semibold">Preguntas Máx:</span> {{ exam.max_questions }}</div>
        {% if exam.is_active %}
          <span class="inline-block px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded">Activo</span>
        {% else %}
          <span class="inline-block px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded">Inactivo</span>
        {% endif %}
      </td>
      <td class="px-4 py-2 text-center">
        {{ exam.start_date|date:'d/M/Y H:i' }} - {{ exam.end_date|date:'d/M/Y H:i' }} <br>
        {% timezone 'America/Bogota' %}
        {% now 'c' as now %}
        {% if exam.start_date|date:'c' <= now and exam.end_date|date:'c' >= now %}
          <span class="inline-block px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded ml-2">Disponible</span>
        {% else %}
          <span class="inline-block px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded ml-2">No disponible</span>
        {% endif %}
        {% endtimezone %}
      </td>
      <td class="px-10 py-2 align-top">
        {% if request.user.role.name == 'super_admin' or request.user.role.name == 'admin' %}
          <ul class="flex flex-col items-start space-y-1">
        <li>
          {% if exam.is_active %}
            <form action="{% url 'exams_deactivate' exam.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="inline-flex items-center text-yellow-500 cursor-pointer">
            <i class="fas fa-toggle-on"></i>
            <span class="ml-2 text-xs hover:underline">Desactivar</span>
          </button>
            </form>
          {% else %}
            <form action="{% url 'exams_activate' exam.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="inline-flex items-center text-gray-400 cursor-pointer">
            <i class="fas fa-toggle-off"></i>
            <span class="ml-2 text-xs hover:underline">Activar</span>
          </button>
            </form>
          {% endif %}
        </li>

        <li>
          <a href="{% url 'exams_update' exam.id %}" class="inline-flex items-center text-indigo-600">
            <i class="fas fa-edit"></i>
            <span class="ml-2 text-xs hover:underline">Editar</span>
          </a>
        </li>

        <li>
          <a href="{% url 'exams_configure_sprt' exam.id %}" class="inline-flex items-center text-purple-600" title="Configurar SPRT">
            <i class="fas fa-cogs"></i>
            <span class="ml-2 text-xs hover:underline">Parámetros</span>
          </a>
        </li>

        <li>
          <a href="{% url 'exams_statistics' exam.id %}" class="inline-flex items-center text-blue-600" title="Ver estadísticas">
            <i class="fas fa-chart-bar"></i>
            <span class="ml-2 text-xs hover:underline">Estadísticas</span>
          </a>
        </li>

        <li>
          <a href="{% url 'exam_students' exam.id %}" class="inline-flex items-center text-gray-600" title="Ver estudiantes inscritos">
            <i class="fas fa-user-graduate"></i>
            <span class="ml-2 text-xs hover:underline">Estudiantes</span>
          </a>
        </li>

        <li>
          <a href="{% url 'exam_export_results' exam.id %}" class="inline-flex items-center text-green-600">
            <i class="fas fa-file-excel"></i>
            <span class="ml-2 text-xs hover:underline">Exportar</span>
          </a>
        </li>
          </ul>

        {% elif request.user.role.name == 'estudiante' %}
          <ul class="flex flex-col items-start space-y-2">
        <li>
          <form action="{% url 'attempt_start' exam.id %}" method="post">
            {% csrf_token %}
            <button type="submit" class="inline-flex items-center text-green-600">
          <i class="fas fa-play"></i>
          <span class="ml-2 text-xs hover:underline">Presentar</span>
            </button>
          </form>
        </li>
          </ul>
        {% endif %}
      </td>
    </tr>
  {% empty %}
    <tr>
      <td colspan="6" class="px-4 py-2 text-center">No hay exámenes disponibles.</td>
    </tr>
  {% endfor %}
{% endblock %}

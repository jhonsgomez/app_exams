{% extends 'base_form.html' %}

{% block page_title %}Gestión | Estudiantes{% endblock %}

{% block back_button %}
    <a href="{% url 'students_table' %}" class="text-indigo-600 inline-flex items-center">
        <i class="fas fa-arrow-left mr-2"></i><span class="hover:underline">Regresar</span>
    </a>
{% endblock %}

{% block form_title %}
    {% if student %}
        Editar
    {% else %}
        Nuevo
    {% endif %}
{% endblock %}

{% block form_badge %}Estudiante{% endblock %}

{% block form_fields %}
    {% if student %}
        <input type="hidden" name="student_id" id="student_id" value="{{ student.pk }}">
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1">Nombres</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                    <i class="fa-solid fa-user"></i>
                </span>
                <input
                    type="text"
                    name="first_name"
                    id="first_name"
                    value="{% if student %}{{ student.first_name }}{% else %}{{ form.first_name.value|default_if_none:'' }}{% endif %}"
                    class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Escribe los nombres del usuario">
            </div>
            {% if form.first_name.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.first_name.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">Apellidos</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                    <i class="fa-solid fa-user"></i>
                </span>
                <input
                    type="text"
                    name="last_name"
                    id="last_name"
                    value="{% if student %}{{ student.last_name }}{% else %}{{ form.last_name.value|default_if_none:'' }}{% endif %}"
                    class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Escribe los apellidos del usuario">
            </div>
            {% if form.last_name.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.last_name.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                    <i class="fa-solid fa-envelope"></i>
                </span>
                <input 
                    type="email" 
                    name="email" 
                    id="email" 
                    class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                    value="{% if student %}{{ student.email }}{% else %}{{ form.email.value|default_if_none:'' }}{% endif %}" 
                    placeholder="Correo electrónico del estudiante">
            </div>
            {% if form.email.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.email.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                    <i class="fa-solid fa-phone"></i>
                </span>
                <input 
                    type="text" 
                    name="phone" 
                    id="phone" 
                    class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                    value="{% if student %}{{ student.phone }}{% else %}{{ form.phone.value|default_if_none:'' }}{% endif %}" 
                    placeholder="Número de teléfono">
            </div>
            {% if form.phone.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.phone.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="document_type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Documento</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                    <i class="fa-solid fa-id-card"></i>
                </span>
                <select name="document_type" id="document_type" class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="" disabled selected>Seleccione un tipo de documento</option>
                    {% for doc_type in document_types %}
                        <option value="{{ doc_type.id }}" {% if student and doc_type.id == student.document_type.id %}selected{% endif %}>{{ doc_type.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if form.document_type.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.document_type.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="document_number" class="block text-sm font-medium text-gray-700 mb-1">Número de Documento</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                    <i class="fa-solid fa-id-card"></i>
                </span>
                <input 
                    type="text" 
                    name="document_number"
                    id="document_number" 
                    class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                    value="{% if student %}{{ student.document_number }}{% else %}{{ form.document_number.value|default_if_none:'' }}{% endif %}" 
                    placeholder="Número de documento">
            </div>
            {% if form.document_number.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.document_number.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="institution" class="block text-sm font-medium text-gray-700 mb-1">Institución</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                    <i class="fa-solid fa-school"></i>
                </span>
                <select name="institution" id="institution" class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="" disabled selected>Seleccione una institución</option>
                    {% for institution in institutions %}
                        <option value="{{ institution.id }}" {% if student and institution.id == student.institution.id %}selected{% endif %}>{{ institution.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if form.institution.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.institution.errors.0 }}</p>
            {% endif %}
        </div>
        <div id="container_academic_department" class="hidden">
            <label for="academic_department" class="block text-sm font-medium text-gray-700 mb-1">Departamento Académico</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                    <i class="fa-solid fa-building"></i>
                </span>
                <select name="academic_department" id="academic_department" class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="" disabled selected>Seleccione un departamento</option>
                    {% for department in academic_departments %}
                        <option value="{{ department.id }}" {% if student and department.id == student.academic_department.id %}selected{% endif %}>{{ department.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if form.academic_department.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.academic_department.errors.0 }}</p>
            {% endif %}
        </div>
        <div id="container_semester" class="hidden">
            <label for="semester" class="block text-sm font-medium text-gray-700 mb-1">Semestre</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                    <i class="fa-solid fa-graduation-cap"></i>
                </span>
                <input 
                    type="number" 
                    name="semester" 
                    id="semester" 
                    class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    value="{% if student %}{{ student.semester }}{% else %}{{ form.semester.value|default_if_none:'' }}{% endif %}" 
                    placeholder="Ejemplo: 5, 6 ....">
            </div>
            {% if form.semester.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.semester.errors.0 }}</p>
            {% endif %}
        </div>
        <div id="container_group" class="hidden">
            <label for="group" class="block text-sm font-medium text-gray-700 mb-1">Grupo</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                    <i class="fa-solid fa-users"></i>
                </span>
                <select name="group" id="group" class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="" disabled selected>Seleccione un grupo</option>
                    {% for group in groups %}
                        <option value="{{ group.id }}" {% if student and group.id == student.group.id %}selected{% endif %}>{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if form.group.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.group.errors.0 }}</p>
            {% endif %}
        </div>
    </div>

    <script>
        const institutionSelect = document.getElementById("institution");
        const academicDeptContainer = document.getElementById("container_academic_department");
        const semesterContainer = document.getElementById("container_semester");
        const semesterInput = document.getElementById("semester");
        const groupContainer = document.getElementById("container_group");
        const academicDeptSelect = document.getElementById("academic_department");
        const groupSelect = document.getElementById("group");

        document.addEventListener("DOMContentLoaded", function () {
            institutionSelect.addEventListener("change", function () {
                semesterInput.value = "";
                loadInstitutionData(this.value);
            });

            {% if student %}
                loadInstitutionData(
                    "{{ student.institution.id }}", 
                    {{ student.academic_department.id|default:"null" }}, 
                    {{ student.group.id|default:"null" }}
                );
            {% endif %}
        });

        function loadInstitutionData(institutionId, selectedDeptId=null, selectedGroupId=null) {
            if (!institutionId) return;

            academicDeptContainer.classList.add("hidden");
            semesterContainer.classList.add("hidden");
            groupContainer.classList.add("hidden");

            academicDeptSelect.innerHTML = '<option value="" disabled selected>Seleccione un departamento</option>';
            groupSelect.innerHTML = '<option value="" disabled selected>Seleccione un grupo</option>';

            fetch(`/institutions/info/${institutionId}/`)
                .then(response => response.json())
                .then(data => {
                    const institutionType = data.institution_type;

                    if (institutionType === 3) {
                        groupContainer.classList.remove("hidden");
                        data.groups.forEach(group => {
                            const option = document.createElement("option");
                            option.value = group.id;
                            option.textContent = group.name;
                            if (selectedGroupId && group.id === selectedGroupId) {
                                option.selected = true;
                            }
                            groupSelect.appendChild(option);
                        });
                    } else {
                        academicDeptContainer.classList.remove("hidden");
                        semesterContainer.classList.remove("hidden");
                        data.departments.forEach(dept => {
                            const option = document.createElement("option");
                            option.value = dept.id;
                            option.textContent = dept.name;
                            if (selectedDeptId && dept.id === selectedDeptId) {
                                option.selected = true;
                            }
                            academicDeptSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error("Error al obtener datos:", error);
                });
        }
    </script>
{% endblock %}

{% block cancel_button %}
    <button type="button" onclick="window.location.href='{% url 'students_table' %}'" class="mt-4 px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 cursor-pointer">
        <i class="fas fa-times"></i> Cancelar
    </button>
{% endblock %}

{% block save_button %}
    <button type="submit" id="saveButton" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 cursor-pointer save-btn" data-url="{% url 'students_save' %}">
        <i class="fas fa-save"></i> Guardar
    </button>
{% endblock %}


